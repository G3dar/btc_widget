<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Trading Backend - Test Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #f7931a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1::before {
            content: "₿";
            font-size: 1.5em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #0f3460;
        }
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 1px solid #0f3460;
            padding-bottom: 10px;
        }
        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .status-item {
            background: #0f3460;
            padding: 15px 25px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        .status-label {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        .status-value.price {
            color: #f7931a;
        }
        .status-value.connected {
            color: #00ff88;
        }
        .status-value.disconnected {
            color: #ff4444;
        }
        input, select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #0f3460;
            background: #1a1a2e;
            color: #eee;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
        }
        button {
            background: #0f3460;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        button:hover {
            background: #00d4ff;
            color: #1a1a2e;
        }
        button.danger {
            background: #ff4444;
        }
        button.danger:hover {
            background: #ff6666;
        }
        button.success {
            background: #00aa55;
        }
        button.success:hover {
            background: #00cc66;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .log-container {
            background: #0d1b2a;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        .log-entry.info {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
        }
        .log-entry.success {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }
        .log-entry.error {
            background: rgba(255, 68, 68, 0.1);
            border-left: 3px solid #ff4444;
        }
        .log-entry.warning {
            background: rgba(255, 170, 0, 0.1);
            border-left: 3px solid #ffaa00;
        }
        .log-time {
            color: #666;
            margin-right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #0f3460;
        }
        th {
            color: #00d4ff;
            font-weight: normal;
        }
        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .badge.buy {
            background: #00aa55;
        }
        .badge.sell {
            background: #ff4444;
        }
        .trailing-card {
            background: #0d1b2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .trailing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .trailing-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.9em;
        }
        .trailing-detail {
            display: flex;
            flex-direction: column;
        }
        .trailing-detail label {
            color: #666;
            font-size: 0.8em;
        }
        .config-section {
            margin-bottom: 15px;
        }
        .config-section label {
            display: block;
            color: #888;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .test-scenario {
            background: #0d1b2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .test-scenario h3 {
            color: #ffaa00;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        .test-scenario p {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        .simulation-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .simulation-controls input {
            width: 120px;
            margin: 0;
        }
        .simulation-controls button {
            width: auto;
            padding: 10px 20px;
            margin: 0;
        }
        .price-change-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 0.8em;
        }
        .price-up {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .price-down {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        .hidden {
            display: none;
        }
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            background: #0f3460;
            border: none;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Backend Test Dashboard</h1>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">Backend Status</span>
                <span class="status-value" id="backend-status">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">BTC/USDT Price</span>
                <span class="status-value price" id="current-price">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Environment</span>
                <span class="status-value" id="environment">Testnet</span>
            </div>
            <div class="status-item">
                <span class="status-label">Trailing Orders</span>
                <span class="status-value" id="trailing-count">0</span>
            </div>
        </div>

        <div class="grid">
            <!-- Configuration -->
            <div class="card">
                <h2>Configuration</h2>
                <div class="config-section">
                    <label>Backend URL</label>
                    <input type="text" id="backend-url" value="http://localhost:3000" placeholder="http://localhost:3000">
                </div>
                <div class="config-section">
                    <label>App Secret</label>
                    <input type="password" id="app-secret" placeholder="Enter app secret from .env">
                </div>
                <div class="form-row">
                    <button onclick="authenticate()">Authenticate</button>
                    <button onclick="checkHealth()">Check Health</button>
                </div>
                <div class="config-section">
                    <label>JWT Token</label>
                    <input type="text" id="jwt-token" readonly placeholder="Token will appear here after auth">
                </div>
                <div class="config-section">
                    <label>
                        <input type="checkbox" id="use-production" onchange="updateEnvironment()">
                        Use Production (CAREFUL!)
                    </label>
                </div>
            </div>

            <!-- Create Order -->
            <div class="card">
                <h2>Create Test Order</h2>
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('limit')">Limit Order</button>
                    <button class="tab-button" onclick="switchTab('market')">Market Order</button>
                </div>

                <div id="tab-limit" class="tab-content active">
                    <div class="form-row">
                        <select id="order-side">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                        <input type="number" id="order-quantity" placeholder="Quantity (BTC)" value="0.001" step="0.0001">
                    </div>
                    <div class="form-row">
                        <input type="number" id="order-price" placeholder="Price (USDT)" step="0.01">
                        <input type="number" id="trailing-percent" placeholder="Trailing % (0=none)" value="0" step="0.1">
                    </div>
                    <button class="success" onclick="createLimitOrder()">Create Limit Order</button>
                </div>

                <div id="tab-market" class="tab-content">
                    <div class="form-row">
                        <select id="market-order-side">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                        <input type="number" id="market-order-quantity" placeholder="Quantity (BTC)" value="0.001" step="0.0001">
                    </div>
                    <button class="success" onclick="createMarketOrder()">Create Market Order</button>
                </div>

                <div style="margin-top: 15px;">
                    <button onclick="setCurrentPrice()">Set Price to Current</button>
                </div>
            </div>

            <!-- Trailing Orders Monitor -->
            <div class="card" style="grid-column: span 2;">
                <h2>Active Trailing Orders</h2>
                <div id="trailing-orders">
                    <p style="color: #666;">No trailing orders active. Create one with trailing % > 0</p>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="refreshTrailingOrders()">Refresh Trailing Orders</button>
                </div>
            </div>

            <!-- Test Scenarios -->
            <div class="card">
                <h2>Trailing Order Test Scenarios</h2>

                <div class="test-scenario">
                    <h3>Scenario 1: BUY Trailing - Price Drops</h3>
                    <p>Create a BUY order at current price with 1% trailing. The order should follow the price down.</p>
                    <button onclick="runScenario1()">Run Test</button>
                </div>

                <div class="test-scenario">
                    <h3>Scenario 2: SELL Trailing - Price Rises</h3>
                    <p>Create a SELL order at current price with 1% trailing. The order should follow the price up.</p>
                    <button onclick="runScenario2()">Run Test</button>
                </div>

                <div class="test-scenario">
                    <h3>Scenario 3: Check Order Adjustment Logic</h3>
                    <p>Inspect the current trailing orders and verify reference prices are updating correctly.</p>
                    <button onclick="runScenario3()">Analyze Orders</button>
                </div>
            </div>

            <!-- Manual Price Simulation -->
            <div class="card">
                <h2>Debug Tools</h2>

                <div class="config-section">
                    <label>Binance Open Orders</label>
                    <button onclick="getOpenOrders()">Fetch Open Orders</button>
                </div>

                <div class="config-section">
                    <label>Cancel Order by ID</label>
                    <div class="form-row">
                        <input type="text" id="cancel-order-id" placeholder="Order ID">
                        <button class="danger" onclick="cancelOrder()">Cancel</button>
                    </div>
                </div>

                <div class="config-section">
                    <label>Account Balance</label>
                    <button onclick="getBalance()">Check Balance</button>
                </div>

                <div class="config-section">
                    <label>Server Outbound IP</label>
                    <button onclick="getOutboundIP()">Check IP</button>
                </div>
            </div>
        </div>

        <!-- Log Output -->
        <div class="card">
            <h2>Activity Log</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry info">
                    <span class="log-time">[--:--:--]</span>
                    Dashboard initialized. Configure backend URL and authenticate.
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="clearLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let jwtToken = null;
        let currentPrice = null;
        let priceInterval = null;
        let trailingInterval = null;

        // Helpers
        function getBackendUrl() {
            return document.getElementById('backend-url').value.replace(/\/$/, '');
        }

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
            log('Log cleared', 'info');
        }

        function updateEnvironment() {
            const isProd = document.getElementById('use-production').checked;
            document.getElementById('environment').textContent = isProd ? 'PRODUCTION' : 'Testnet';
            document.getElementById('environment').style.color = isProd ? '#ff4444' : '#00ff88';
            log(`Switched to ${isProd ? 'PRODUCTION' : 'Testnet'} environment`, isProd ? 'warning' : 'info');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // API Calls
        async function apiCall(endpoint, options = {}) {
            const url = getBackendUrl() + endpoint;
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (jwtToken) {
                headers['Authorization'] = `Bearer ${jwtToken}`;
            }

            if (document.getElementById('use-production').checked) {
                headers['X-Use-Production'] = 'true';
            }

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                return data;
            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Cannot connect to backend. Is it running?');
                }
                throw error;
            }
        }

        async function checkHealth() {
            try {
                const data = await apiCall('/debug/health');
                document.getElementById('backend-status').textContent = 'Connected';
                document.getElementById('backend-status').className = 'status-value connected';
                log('Backend health check: OK', 'success');

                // Start price updates
                startPriceUpdates();
            } catch (error) {
                document.getElementById('backend-status').textContent = 'Disconnected';
                document.getElementById('backend-status').className = 'status-value disconnected';
                log(`Health check failed: ${error.message}`, 'error');
            }
        }

        async function authenticate() {
            const appSecret = document.getElementById('app-secret').value;
            if (!appSecret) {
                log('Please enter App Secret from .env file', 'error');
                return;
            }

            try {
                const data = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        device_id: 'test-dashboard-' + Date.now(),
                        device_name: 'Test Dashboard',
                        app_secret: appSecret
                    })
                });

                jwtToken = data.token;
                document.getElementById('jwt-token').value = jwtToken;
                log('Authentication successful!', 'success');

                // Start trailing orders refresh
                startTrailingUpdates();
                refreshTrailingOrders();
            } catch (error) {
                log(`Authentication failed: ${error.message}`, 'error');
            }
        }

        async function fetchPrice() {
            try {
                const data = await apiCall('/price/current');
                const newPrice = parseFloat(data.price);

                if (currentPrice !== null) {
                    const priceEl = document.getElementById('current-price');
                    if (newPrice > currentPrice) {
                        priceEl.innerHTML = `$${newPrice.toFixed(2)} <span class="price-change-indicator price-up">▲</span>`;
                    } else if (newPrice < currentPrice) {
                        priceEl.innerHTML = `$${newPrice.toFixed(2)} <span class="price-change-indicator price-down">▼</span>`;
                    } else {
                        priceEl.textContent = `$${newPrice.toFixed(2)}`;
                    }
                } else {
                    document.getElementById('current-price').textContent = `$${newPrice.toFixed(2)}`;
                }

                currentPrice = newPrice;
            } catch (error) {
                // Silent fail for price updates
            }
        }

        function startPriceUpdates() {
            if (priceInterval) clearInterval(priceInterval);
            fetchPrice();
            priceInterval = setInterval(fetchPrice, 5000);
        }

        function startTrailingUpdates() {
            if (trailingInterval) clearInterval(trailingInterval);
            trailingInterval = setInterval(refreshTrailingOrders, 10000);
        }

        async function refreshTrailingOrders() {
            if (!jwtToken) {
                log('Please authenticate first', 'warning');
                return;
            }

            try {
                const data = await apiCall('/trailing/orders');
                document.getElementById('trailing-count').textContent = data.count;

                const container = document.getElementById('trailing-orders');

                if (data.orders.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No trailing orders active. Create one with trailing % > 0</p>';
                    return;
                }

                container.innerHTML = data.orders.map(order => `
                    <div class="trailing-card">
                        <div class="trailing-header">
                            <span>
                                <span class="badge ${order.side.toLowerCase()}">${order.side}</span>
                                Order #${order.order_id}
                            </span>
                            <button class="danger" style="width: auto; padding: 5px 15px; margin: 0;"
                                    onclick="stopTrailing('${order.id}')">Stop Trailing</button>
                        </div>
                        <div class="trailing-details">
                            <div class="trailing-detail">
                                <label>Current Price</label>
                                <span>$${order.current_order_price.toFixed(2)}</span>
                            </div>
                            <div class="trailing-detail">
                                <label>Reference Price</label>
                                <span>$${order.reference_price.toFixed(2)}</span>
                            </div>
                            <div class="trailing-detail">
                                <label>Trailing %</label>
                                <span>${order.trailing_percent}%</span>
                            </div>
                            <div class="trailing-detail">
                                <label>Quantity</label>
                                <span>${order.quantity} BTC</span>
                            </div>
                            <div class="trailing-detail">
                                <label>Target Price</label>
                                <span>$${calculateTarget(order).toFixed(2)}</span>
                            </div>
                            <div class="trailing-detail">
                                <label>Adjustment Needed</label>
                                <span>${needsAdjustment(order) ? '⚠️ YES' : '✓ No'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                log(`Failed to fetch trailing orders: ${error.message}`, 'error');
            }
        }

        function calculateTarget(order) {
            if (order.side === 'BUY') {
                return order.reference_price * (1 + order.trailing_percent / 100);
            } else {
                return order.reference_price * (1 - order.trailing_percent / 100);
            }
        }

        function needsAdjustment(order) {
            const target = calculateTarget(order);
            if (order.side === 'BUY') {
                const diff = (order.current_order_price - target) / order.current_order_price;
                return diff > 0.001;
            } else {
                const diff = (target - order.current_order_price) / order.current_order_price;
                return diff > 0.001;
            }
        }

        async function stopTrailing(id) {
            if (!confirm('Stop trailing for this order? The order will remain on Binance but won\'t be adjusted.')) {
                return;
            }

            try {
                await apiCall(`/trailing/order/${id}`, { method: 'DELETE' });
                log(`Stopped trailing for order ${id}`, 'success');
                refreshTrailingOrders();
            } catch (error) {
                log(`Failed to stop trailing: ${error.message}`, 'error');
            }
        }

        function setCurrentPrice() {
            if (currentPrice) {
                document.getElementById('order-price').value = currentPrice.toFixed(2);
                log(`Set order price to current market price: $${currentPrice.toFixed(2)}`, 'info');
            } else {
                log('Current price not available yet', 'warning');
            }
        }

        async function createLimitOrder() {
            if (!jwtToken) {
                log('Please authenticate first', 'warning');
                return;
            }

            const side = document.getElementById('order-side').value;
            const price = parseFloat(document.getElementById('order-price').value);
            const quantity = parseFloat(document.getElementById('order-quantity').value);
            const trailingPercent = parseFloat(document.getElementById('trailing-percent').value) || null;

            if (!price || !quantity) {
                log('Please enter price and quantity', 'error');
                return;
            }

            try {
                const body = {
                    side,
                    price,
                    quantity
                };

                if (trailingPercent && trailingPercent > 0) {
                    body.trailing_percent = trailingPercent;
                }

                const data = await apiCall('/order/limit', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });

                log(`Created ${side} limit order #${data.orderId} at $${price} qty ${quantity}${trailingPercent ? ` with ${trailingPercent}% trailing` : ''}`, 'success');

                if (trailingPercent) {
                    setTimeout(refreshTrailingOrders, 1000);
                }
            } catch (error) {
                log(`Failed to create order: ${error.message}`, 'error');
            }
        }

        async function createMarketOrder() {
            if (!jwtToken) {
                log('Please authenticate first', 'warning');
                return;
            }

            const side = document.getElementById('market-order-side').value;
            const quantity = parseFloat(document.getElementById('market-order-quantity').value);

            if (!quantity) {
                log('Please enter quantity', 'error');
                return;
            }

            try {
                const data = await apiCall('/order/market', {
                    method: 'POST',
                    body: JSON.stringify({ side, quantity })
                });

                log(`Created ${side} market order #${data.orderId} qty ${quantity}`, 'success');
            } catch (error) {
                log(`Failed to create market order: ${error.message}`, 'error');
            }
        }

        async function getOpenOrders() {
            if (!jwtToken) {
                log('Please authenticate first', 'warning');
                return;
            }

            try {
                const data = await apiCall('/account/open-orders');
                log(`Found ${data.length} open orders on Binance`, 'info');
                data.forEach(order => {
                    log(`  Order #${order.orderId}: ${order.side} ${order.origQty} @ $${order.price}`, 'info');
                });
            } catch (error) {
                log(`Failed to fetch open orders: ${error.message}`, 'error');
            }
        }

        async function cancelOrder() {
            if (!jwtToken) {
                log('Please authenticate first', 'warning');
                return;
            }

            const orderId = document.getElementById('cancel-order-id').value;
            if (!orderId) {
                log('Please enter order ID', 'error');
                return;
            }

            try {
                await apiCall(`/account/cancel/${orderId}`, { method: 'DELETE' });
                log(`Cancelled order #${orderId}`, 'success');
                document.getElementById('cancel-order-id').value = '';
            } catch (error) {
                log(`Failed to cancel order: ${error.message}`, 'error');
            }
        }

        async function getBalance() {
            if (!jwtToken) {
                log('Please authenticate first', 'warning');
                return;
            }

            try {
                const data = await apiCall('/account/balance');
                log(`Balance: ${data.btc.free.toFixed(6)} BTC (free), ${data.usdt.free.toFixed(2)} USDT (free)`, 'info');
                log(`Total portfolio: $${data.total_usd.toFixed(2)} USD`, 'info');
            } catch (error) {
                log(`Failed to fetch balance: ${error.message}`, 'error');
            }
        }

        async function getOutboundIP() {
            try {
                const data = await apiCall('/debug/outbound-ip');
                log(`Server outbound IP: ${data.outbound_ip}`, 'info');
                log(data.message, 'warning');
            } catch (error) {
                log(`Failed to get outbound IP: ${error.message}`, 'error');
            }
        }

        // Test Scenarios
        async function runScenario1() {
            log('=== SCENARIO 1: BUY Trailing - Price Drop Test ===', 'warning');

            if (!jwtToken) {
                log('Please authenticate first', 'error');
                return;
            }

            if (!currentPrice) {
                log('Waiting for price...', 'info');
                await fetchPrice();
            }

            // Create a BUY order at current price + 2% with 1% trailing
            const orderPrice = Math.round(currentPrice * 1.02 * 100) / 100;
            const quantity = 0.001;
            const trailingPercent = 1.0;

            log(`Creating BUY order at $${orderPrice} (current price $${currentPrice}) with ${trailingPercent}% trailing`, 'info');
            log(`Expected behavior: As price drops below $${currentPrice}, reference will update and order should move down`, 'info');

            try {
                const data = await apiCall('/order/limit', {
                    method: 'POST',
                    body: JSON.stringify({
                        side: 'BUY',
                        price: orderPrice,
                        quantity,
                        trailing_percent: trailingPercent
                    })
                });

                log(`Order created: #${data.orderId}`, 'success');
                log('Now watch the trailing orders panel. The monitor runs every 10 seconds.', 'info');
                log('If price drops, reference_price should update and order should adjust.', 'info');

                setTimeout(refreshTrailingOrders, 1000);
            } catch (error) {
                log(`Scenario 1 failed: ${error.message}`, 'error');
            }
        }

        async function runScenario2() {
            log('=== SCENARIO 2: SELL Trailing - Price Rise Test ===', 'warning');

            if (!jwtToken) {
                log('Please authenticate first', 'error');
                return;
            }

            if (!currentPrice) {
                await fetchPrice();
            }

            // Create a SELL order at current price - 2% with 1% trailing
            const orderPrice = Math.round(currentPrice * 0.98 * 100) / 100;
            const quantity = 0.001;
            const trailingPercent = 1.0;

            log(`Creating SELL order at $${orderPrice} (current price $${currentPrice}) with ${trailingPercent}% trailing`, 'info');
            log(`Expected behavior: As price rises above $${currentPrice}, reference will update and order should move up`, 'info');

            try {
                const data = await apiCall('/order/limit', {
                    method: 'POST',
                    body: JSON.stringify({
                        side: 'SELL',
                        price: orderPrice,
                        quantity,
                        trailing_percent: trailingPercent
                    })
                });

                log(`Order created: #${data.orderId}`, 'success');
                log('Now watch the trailing orders panel. The monitor runs every 10 seconds.', 'info');

                setTimeout(refreshTrailingOrders, 1000);
            } catch (error) {
                log(`Scenario 2 failed: ${error.message}`, 'error');
            }
        }

        async function runScenario3() {
            log('=== SCENARIO 3: Trailing Order Analysis ===', 'warning');

            if (!jwtToken) {
                log('Please authenticate first', 'error');
                return;
            }

            try {
                const data = await apiCall('/trailing/orders');

                if (data.orders.length === 0) {
                    log('No trailing orders to analyze. Create one first.', 'warning');
                    return;
                }

                for (const order of data.orders) {
                    log(`--- Order ${order.id.slice(0, 8)}... ---`, 'info');
                    log(`  Side: ${order.side}`, 'info');
                    log(`  Current order price: $${order.current_order_price}`, 'info');
                    log(`  Reference price: $${order.reference_price}`, 'info');
                    log(`  Trailing: ${order.trailing_percent}%`, 'info');

                    const target = calculateTarget(order);
                    log(`  Target price: $${target.toFixed(2)}`, 'info');

                    if (order.side === 'BUY') {
                        const diff = (order.current_order_price - target) / order.current_order_price * 100;
                        log(`  Price diff: ${diff.toFixed(2)}% (needs adjustment if > 0.1%)`, diff > 0.1 ? 'warning' : 'success');

                        if (order.reference_price === order.current_order_price) {
                            log(`  ⚠️ BUG DETECTED: reference_price equals current_order_price`, 'error');
                            log(`  This likely means reference wasn't initialized to market price`, 'error');
                        }
                    } else {
                        const diff = (target - order.current_order_price) / order.current_order_price * 100;
                        log(`  Price diff: ${diff.toFixed(2)}% (needs adjustment if > 0.1%)`, diff > 0.1 ? 'warning' : 'success');
                    }

                    if (currentPrice) {
                        log(`  Current market: $${currentPrice.toFixed(2)}`, 'info');
                        if (order.side === 'BUY' && currentPrice < order.reference_price) {
                            log(`  Reference should update to: $${currentPrice.toFixed(2)}`, 'warning');
                        } else if (order.side === 'SELL' && currentPrice > order.reference_price) {
                            log(`  Reference should update to: $${currentPrice.toFixed(2)}`, 'warning');
                        }
                    }
                }
            } catch (error) {
                log(`Analysis failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            log('Dashboard ready. Enter App Secret and click Authenticate to start.', 'info');
        });
    </script>
</body>
</html>
